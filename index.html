<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iSchool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- 核心样式 --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); animation: fadeIn 0.2s ease-out; }
        .dashboard-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        .class-btn.active { background-color: #2563eb; color: white; border-left: 4px solid #1e40af; }
        .school-input-group:focus-within i { color: #2563eb; }
        
        /* 动画 */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tag-item { background: #eff6ff; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .tag-remove { margin-left: 0.25rem; cursor: pointer; color: #3b82f6; }
        .custom-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #2563eb; }

        /* 点名按钮样式 */
        .att-btn { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid #e5e7eb; transition: all 0.2s; }
        .att-btn:hover { transform: scale(1.05); }
        .att-btn.selected { border-color: transparent; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .att-present.selected { background-color: #22c55e; }
        .att-absent.selected { background-color: #ef4444; }
        .att-late.selected { background-color: #f59e0b; }
        .att-excused.selected { background-color: #3b82f6; }

        /* === 打印与预览通用样式 (Report Styles) === */
        .report-container {
            width: 100%;
            background: white;
            color: black;
            font-family: 'Times New Roman', serif;
            box-sizing: border-box;
        }
        .report-header {
            text-align: center;
            margin-bottom: 5px;
        }
        .report-school-name {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            text-transform: uppercase;
            text-align: center;
            letter-spacing: 1px;
        }
        .report-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 2px;
            border-bottom: 2px solid black;
            padding-bottom: 2px;
            font-size: 12px;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }
        
        /* --- 智能紧凑表格核心 --- */
        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            table-layout: auto;
        }
        .report-table th, .report-table td {
            border: 1px solid black;
            padding: 2px 4px;
            text-align: center;
            height: 20px;
            overflow: hidden;
            white-space: nowrap;
            vertical-align: middle;
        }

        /* --- 列宽策略 --- */
        .col-fit { width: 1%; white-space: nowrap; }
        .col-name-ch { width: 1%; white-space: nowrap; text-align: center !important; }
        .col-name-en { width: 1%; white-space: nowrap; text-align: center !important; }
        .col-std-id { width: 1%; white-space: nowrap; }
        /* 日期列 (紧凑) */
        .col-date { width: 35px; font-size: 10px; }

        /* 周末列样式：字体竖排，灰色背景，更紧凑 */
        .cell-weekend {
            background-color: #f3f4f6 !important; /* 浅灰背景，打印可见 */
            color: #9ca3af;
            font-size: 9px;
            writing-mode: vertical-rl; /* 竖排文字 */
            text-orientation: upright;
            letter-spacing: 2px;
            padding: 0 !important;
        }

        .report-footer {
            margin-top: 5px;
            font-size: 11px;
            font-weight: bold;
            font-family: Arial, sans-serif;
        }

        /* === 打印专用设置 (@media print) === */
        @media print {
            @page { size: A4; margin: 5mm; } 
            html, body { background-color: #ffffff !important; background-image: none !important; margin: 0; padding: 0; }
            body * { visibility: hidden; }
            #print-area { 
                visibility: visible; 
                display: block !important;
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0;
                padding: 0;
                background-color: white !important; 
            }
            #print-area * { visibility: visible; }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* === 屏幕预览专用 === */
        #print-area { display: none; }
        #print-preview-container {
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            margin: 0 auto;
            width: 210mm; 
            min-height: 297mm; 
            padding: 5mm; 
            transform-origin: top center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-700">

    <!-- 真正的打印容器 -->
    <div id="print-area"></div>

    <!-- 维护拦截 -->
    <div id="maintenance-overlay" class="fixed inset-0 z-[90] bg-gray-900/90 flex flex-col items-center justify-center text-white hidden text-center p-6 no-print">
        <div class="bg-white/10 p-8 rounded-2xl backdrop-blur-md max-w-lg w-full border border-white/20 shadow-2xl">
            <i class="fas fa-tools text-6xl mb-6 text-yellow-400 animate-bounce"></i>
            <h2 class="text-3xl font-bold mb-2">系统维护中</h2>
            <p class="text-xl text-blue-200 font-mono mb-6" id="maintenance-msg-overlay">System Maintenance</p>
            <button onclick="location.reload()" class="mt-8 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full transition font-bold"><i class="fas fa-sync-alt mr-2"></i> 刷新页面</button>
            <div class="mt-4"><button onclick="APP.ui.toggleMaintenanceLogin()" class="text-xs text-gray-500 hover:text-white underline">管理员通道</button></div>
        </div>
    </div>

    <!-- 导航栏 -->
    <nav id="navbar" class="bg-slate-800 text-white p-4 hidden shadow-lg z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer select-none" onclick="APP.router.navigate('dashboard')">
                <div class="bg-white/10 p-2 rounded-lg"><i class="fas fa-school text-2xl text-blue-400"></i></div>
                <div><h1 class="text-xl font-bold leading-tight">iSchool</h1><p id="nav-school-name" class="text-xs text-gray-400 font-medium">云端系统</p></div>
            </div>
            <div class="flex items-center gap-4">
                <button id="btn-god-mode-exit" onclick="APP.auth.exitGodMode()" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg animate-pulse"><i class="fas fa-power-off"></i> 退出上帝视角</button>
                <div class="hidden md:flex items-center bg-slate-700/50 rounded-full px-3 py-1"><div class="w-2 h-2 rounded-full bg-green-400 animate-pulse mr-2"></div><span class="text-xs text-gray-300">实时连接</span></div>
                <button onclick="APP.ui.showMyPermissions()" class="flex items-center gap-2 hover:bg-white/10 px-3 py-1.5 rounded-lg transition"><i class="fas fa-user"></i><span id="nav-user-id" class="text-sm font-bold hidden sm:block">User</span></button>
                <button onclick="APP.auth.logout()" class="text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt text-lg"></i></button>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="flex-grow flex flex-col items-center justify-center p-4 relative w-full max-w-7xl mx-auto no-print">
        <div id="global-loading" class="absolute inset-0 bg-gray-100 z-[60] flex flex-col items-center justify-center">
            <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-500 font-medium animate-pulse">正在连接云端...</p>
        </div>

        <!-- 1. 登录 -->
        <div id="view-login" class="w-full max-w-md hidden animate-fade-in">
            <div id="login-maintenance-alert" class="hidden mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded shadow-sm text-yellow-700 text-sm font-bold pl-4 py-3"><i class="fas fa-exclamation-triangle mr-2"></i> <span id="login-maintenance-msg">维护中</span></div>
            <div class="glass-panel rounded-2xl p-8 relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 to-pink-500"></div>
                <div class="text-center mb-8 mt-2"><h2 class="text-3xl font-extrabold text-gray-800">iSchool</h2><p class="text-gray-500 text-sm">多校区数字化管理平台</p></div>
                <form id="form-login" class="space-y-5">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">学校编号 / School Code</label><div class="school-input-group relative"><span class="absolute left-3 top-3 text-gray-400"><i class="fas fa-building"></i></span><input type="text" id="login-school-code" required class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none uppercase font-mono" placeholder="ABC0001" oninput="APP.auth.checkSchoolCode(this.value)"></div><div id="school-name-display" class="h-5 mt-1 text-xs font-bold transition-all duration-300 opacity-0"></div></div>
                    <div class="space-y-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">ID</label><div class="relative"><span class="absolute left-3 top-3 text-gray-400"><i class="fas fa-id-card"></i></span><input type="text" id="login-id" required class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg outline-none" placeholder="admin"></div></div><div><label class="block text-xs font-bold text-gray-500 mb-1">密码</label><div class="relative"><span class="absolute left-3 top-3 text-gray-400"><i class="fas fa-lock"></i></span><input type="password" id="login-pwd" required class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg outline-none" placeholder="••••••"></div></div></div>
                    <div id="login-error" class="text-red-500 text-sm text-center hidden bg-red-50 p-2 rounded border border-red-100"></div>
                    <button type="submit" id="btn-login-submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 rounded-lg transition shadow-lg flex justify-center items-center gap-2"><span>进入系统</span> <i class="fas fa-arrow-right"></i></button>
                </form>
            </div>
        </div>

        <!-- 2. 系统总控台 -->
        <div id="view-system-console" class="w-full hidden h-full flex-col animate-fade-in">
            <div class="mb-8 text-center"><span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">SUPER ADMIN</span><h2 class="text-3xl font-bold text-gray-800 mt-2">系统总控中心</h2></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                <div class="space-y-6">
                    <div class="glass-panel rounded-xl p-6"><h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-plus-circle text-blue-600 mr-2"></i> 注册新学校</h3><form id="form-create-school" class="space-y-4"><div><label class="text-xs font-bold text-gray-500">全称</label><input type="text" id="sys-school-name" required class="w-full p-2 border rounded mt-1"></div><div><label class="text-xs font-bold text-gray-500">编号</label><input type="text" id="sys-school-code" required maxlength="7" class="w-full p-2 border rounded mt-1 uppercase font-mono"></div><div><label class="text-xs font-bold text-gray-500">Admin 密码</label><input type="text" id="sys-admin-pwd" required class="w-full p-2 border rounded mt-1 font-mono" value="123456"></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold shadow">创建</button></form></div>
                    
                    <!-- 学年设置 -->
                    <div class="glass-panel rounded-xl p-6 border-l-4 border-green-500">
                        <h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-calendar-alt text-green-600 mr-2"></i> 学年设置</h3>
                        <form id="form-academic-year" class="space-y-3">
                            <div><label class="text-xs font-bold text-gray-500">当前学年</label><input type="text" id="sys-ay-name" class="w-full p-2 border rounded mt-1" placeholder="2025"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs font-bold text-gray-500">开始</label><input type="date" id="sys-ay-start" class="w-full p-1 border rounded text-xs"></div>
                                <div><label class="text-xs font-bold text-gray-500">结束</label><input type="date" id="sys-ay-end" class="w-full p-1 border rounded text-xs"></div>
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-1.5 rounded text-sm font-bold mt-2">保存学年</button>
                        </form>
                    </div>

                    <div class="glass-panel rounded-xl p-6 border-l-4 border-yellow-400"><h3 class="text-lg font-bold text-gray-800 mb-4"><i class="fas fa-tools text-yellow-500 mr-2"></i> 维护模式</h3><form id="form-maintenance" class="space-y-3"><div><label class="text-xs font-bold text-gray-500">公告</label><input type="text" id="maint-msg" class="w-full p-2 border rounded mt-1"></div><div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-gray-500">开始</label><input type="datetime-local" id="maint-start" class="w-full p-1 border rounded text-xs"></div><div><label class="text-xs font-bold text-gray-500">结束</label><input type="datetime-local" id="maint-end" class="w-full p-1 border rounded text-xs"></div></div><div class="flex items-center justify-between pt-2"><label class="flex items-center cursor-pointer"><input type="checkbox" id="maint-active" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:bg-blue-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div><span class="ml-3 text-sm font-medium text-gray-700">启用</span></label><button type="submit" class="bg-gray-800 text-white px-3 py-1 rounded text-xs">保存</button></div></form></div>
                </div>
                <div class="lg:col-span-2 glass-panel rounded-xl p-0 overflow-hidden flex flex-col h-[600px]"><div class="p-4 border-b bg-gray-50"><h3 class="font-bold text-gray-700">已注册学校</h3></div><div class="flex-1 overflow-auto p-4"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 bg-gray-100"><tr><th class="px-4 py-2">编号</th><th class="px-4 py-2">名称</th><th class="px-4 py-2 text-right">操作</th></tr></thead><tbody id="system-school-list"></tbody></table></div></div>
            </div>
        </div>

        <!-- 3. 仪表盘 -->
        <div id="view-dashboard" class="w-full hidden animate-fade-in">
            <div class="text-center mb-10"><h2 class="text-4xl font-bold text-gray-800 tracking-tight">工作台</h2><p class="text-gray-500 mt-2 text-lg" id="dashboard-school-name">加载中...</p></div>
            <div id="dashboard-card-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto"></div>
        </div>

        <!-- 4. 账号管理 -->
        <div id="view-admin" class="w-full hidden h-full flex-col animate-fade-in">
            <div class="flex items-center justify-between mb-6"><button onclick="APP.router.navigate('dashboard')" class="text-gray-500 hover:text-blue-600 font-bold"><i class="fas fa-arrow-left"></i> 返回</button><h2 class="text-2xl font-bold text-gray-800">后台管理</h2><div class="w-10"></div></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                <div class="lg:col-span-2 space-y-6">
                    <div class="glass-panel rounded-xl p-6" id="admin-add-user-panel"><h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">创建账号</h3><form id="form-add-user" class="flex gap-4 items-end"><input type="text" id="new-user-id" placeholder="ID" required class="flex-1 p-2 border rounded"><input type="text" id="new-user-pwd" placeholder="密码" required class="flex-1 p-2 border rounded"><button type="submit" class="bg-green-600 text-white px-6 py-2 rounded shadow">添加</button></form></div>
                    <div class="glass-panel rounded-xl p-0 overflow-hidden"><div class="p-4 border-b bg-gray-50"><h3 class="font-bold text-gray-700">账号列表</h3></div><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-xs uppercase"><tr><th class="px-6 py-3">ID</th><th class="px-6 py-3">权限</th><th class="px-6 py-3">密码</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="user-list-body"></tbody></table></div></div>
                </div>
                <div class="glass-panel rounded-xl p-0 flex flex-col h-[600px]"><div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-gray-700">日志</h3><button onclick="APP.data.clearLogs()" class="text-red-500 text-xs hover:underline">清空</button></div><div class="flex-1 overflow-y-auto p-4 space-y-3" id="log-container"></div></div>
            </div>
        </div>

        <!-- 5. 学生资料 -->
        <div id="view-student-data" class="w-full hidden h-full flex-col animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4"><button onclick="APP.router.navigate('dashboard')" class="text-gray-500 hover:text-blue-600 font-bold"><i class="fas fa-arrow-left"></i> 返回</button><h2 class="text-2xl font-bold text-gray-800">学生资料库</h2></div>
                <div class="flex gap-3">
                    <button id="btn-config-data" onclick="APP.ui.openConfigModal()" class="hidden bg-orange-500 text-white px-4 py-2 rounded shadow text-sm"><i class="fas fa-sliders-h mr-2"></i> 设定</button>
                    <button id="btn-manage-classes" onclick="APP.ui.openClassModal()" class="hidden bg-purple-600 text-white px-4 py-2 rounded shadow text-sm"><i class="fas fa-layer-group mr-2"></i> 班级</button>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full min-h-[600px]">
                <div class="glass-panel rounded-xl p-0 flex flex-col h-full overflow-hidden"><div class="p-4 bg-gray-50 border-b"><h3 class="font-bold text-gray-700">班级列表</h3></div><div id="class-list-container" class="flex-1 overflow-y-auto p-2 space-y-1"></div></div>
                <div class="lg:col-span-3 glass-panel rounded-xl p-0 flex flex-col h-full overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center bg-white">
                        <div>
                            <h3 id="current-class-title" class="text-xl font-bold text-blue-800">请选择班级</h3>
                            <p id="current-class-info" class="text-sm text-gray-400 mt-1">点击左侧列表查看详情</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-batch-move" onclick="APP.ui.openBatchMoveModal()" class="hidden bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg shadow font-medium text-sm"><i class="fas fa-exchange-alt mr-2"></i> 批量调班</button>
                            <button id="btn-print-list" onclick="APP.print.openPrintPreview()" class="hidden bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg shadow font-medium text-sm"><i class="fas fa-print mr-2"></i> 打印名单</button>
                            <button id="btn-add-student" onclick="APP.ui.openStudentModal()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow font-medium"><i class="fas fa-user-plus mr-2"></i> 添加学生</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-gray-50/50">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 shadow-sm">
                                <tr>
                                    <th class="px-4 py-3 w-10"><input type="checkbox" class="custom-checkbox" onchange="APP.actions.toggleSelectAll(this.checked)"></th>
                                    <th class="px-6 py-3">学号/姓名</th>
                                    <th class="px-6 py-3">性别/种族</th>
                                    <th class="px-6 py-3">身份证号</th>
                                    <th class="px-6 py-3 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body" class="divide-y divide-gray-200"><tr><td colspan="5" class="text-center py-20 text-gray-400">请选择左侧班级</td></tr></tbody>
                        </table>
                    </div>
                    <div class="p-2 bg-gray-100 flex justify-between items-center text-xs text-gray-500 border-t">
                        <span id="selected-count-display" class="font-bold text-blue-600 hidden">已选: 0 人</span>
                        <span>总数: <span id="student-count" class="font-bold">0</span> 人</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 6. 班级点名 -->
        <div id="view-attendance" class="w-full hidden h-full flex-col animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-4"><button onclick="APP.router.navigate('dashboard')" class="text-gray-500 hover:text-blue-600 font-bold"><i class="fas fa-arrow-left"></i> 返回</button><h2 class="text-2xl font-bold text-gray-800">班级点名</h2></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full min-h-[600px]">
                <div class="glass-panel rounded-xl p-0 flex flex-col h-full overflow-hidden"><div class="p-4 bg-gray-50 border-b"><h3 class="font-bold text-gray-700">选择班级</h3></div><div id="att-class-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div></div>
                <div class="lg:col-span-3 glass-panel rounded-xl p-0 flex flex-col h-full overflow-hidden">
                    <div class="p-6 border-b bg-white flex justify-between items-end">
                        <div>
                            <h3 id="att-class-title" class="text-xl font-bold text-blue-800">请选择班级</h3>
                            <div class="flex items-center gap-3 mt-2">
                                <input type="date" id="att-date-picker" class="p-1 border rounded text-sm font-bold text-gray-600">
                                <span id="att-summary" class="text-xs text-gray-500 font-mono"></span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-print-att" onclick="APP.print.openAttendancePrintPreview()" class="hidden bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg shadow font-bold flex items-center gap-2"><i class="fas fa-print"></i> 打印</button>
                            <button id="btn-save-attendance" onclick="APP.attendance.save()" class="hidden bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow font-bold flex items-center gap-2"><i class="fas fa-save"></i> 保存记录</button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto bg-gray-50/50">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-100 sticky top-0 shadow-sm">
                                <tr><th class="px-6 py-3 w-16">序号</th><th class="px-6 py-3">学生姓名</th><th class="px-6 py-3 text-center">状态</th></tr>
                            </thead>
                            <tbody id="att-student-list" class="divide-y divide-gray-200"><tr><td colspan="3" class="text-center py-20 text-gray-400">请选择班级和日期</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 模态框：打印预览 -->
    <div id="modal-print" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-backdrop no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 h-[90vh] flex flex-col animate-fade-in">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold"><i class="fas fa-print mr-2"></i> 打印预览</h3>
                <div>
                    <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded font-bold text-sm mr-2"><i class="fas fa-print"></i> 立即打印</button>
                    <button onclick="APP.ui.closeModal('modal-print')" class="text-gray-300 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-auto p-8 bg-gray-200 flex justify-center">
                <div id="print-preview-container" class="report-container" style="width: 210mm; min-height: 297mm; padding: 5mm; transform-origin: top center;">
                    <!-- 内容由JS注入 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：班级管理 -->
    <div id="modal-classes" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden flex flex-col max-h-[80vh] animate-fade-in">
            <div class="bg-purple-800 text-white p-4 flex justify-between items-center"><h3 class="font-bold">班级管理</h3><button onclick="APP.ui.closeModal('modal-classes')" class="hover:bg-white/20 rounded p-1"><i class="fas fa-times"></i></button></div>
            <div class="p-6 border-b bg-gray-50"><form id="form-add-class" class="flex gap-2"><input type="text" id="input-class-year" placeholder="年份 (2025)" class="w-24 p-2 border rounded text-center" required><input type="text" id="input-class-name" placeholder="班级名 (1B)" class="flex-1 p-2 border rounded" required><button type="submit" class="bg-purple-600 text-white px-4 rounded font-bold">添加</button></form></div>
            <div class="flex-1 overflow-y-auto"><table class="w-full text-sm text-left text-gray-600"><thead class="bg-gray-100 text-xs uppercase"><tr><th class="px-4 py-3">年份/班级</th><th class="px-4 py-3">班主任</th><th class="px-4 py-3 text-right">操作</th></tr></thead><tbody id="manage-class-list-body"></tbody></table></div>
        </div>
    </div>
    
    <div id="modal-edit-class" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 p-6 animate-fade-in">
            <h3 class="font-bold mb-4">班级设置</h3>
            <form id="form-edit-class" class="space-y-4">
                <input type="hidden" id="edit-class-id">
                <div><label class="text-xs font-bold text-gray-500">班级名称</label><input type="text" id="edit-class-name" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="text-xs font-bold text-gray-500">班主任</label><select id="edit-class-teacher" class="w-full p-2 border rounded mt-1"><option value="">-- 无 --</option></select></div>
                <div class="flex justify-end gap-3 mt-4"><button type="button" onclick="APP.ui.closeModal('modal-edit-class')" class="px-4 py-2 bg-gray-100 rounded font-medium">取消</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded font-medium">保存</button></div>
            </form>
        </div>
    </div>

    <!-- 其他模态框 -->
    <div id="modal-data-config" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop no-print"><div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden animate-fade-in h-[80vh] flex flex-col"><div class="bg-orange-600 text-white p-4 flex justify-between items-center"><h3 class="font-bold">资料设定</h3><button onclick="APP.ui.closeModal('modal-data-config')" class="hover:bg-white/20 rounded p-1"><i class="fas fa-times"></i></button></div><div class="p-6 flex-1 overflow-y-auto bg-gray-50 space-y-6"><div class="bg-white p-4 rounded shadow-sm"><h4 class="font-bold text-gray-700 mb-2">种族</h4><div class="flex gap-2 mb-3"><input type="text" id="input-new-race" class="flex-1 p-2 border rounded text-sm"><button onclick="APP.actions.addConfigOption('races')" class="bg-blue-100 text-blue-700 px-4 rounded text-sm font-bold">添加</button></div><div id="list-races" class="tag-input-container"></div></div><div class="bg-white p-4 rounded shadow-sm"><h4 class="font-bold text-gray-700 mb-2">宗教</h4><div class="flex gap-2 mb-3"><input type="text" id="input-new-religion" class="flex-1 p-2 border rounded text-sm"><button onclick="APP.actions.addConfigOption('religions')" class="bg-purple-100 text-purple-700 px-4 rounded text-sm font-bold">添加</button></div><div id="list-religions" class="tag-input-container"></div></div></div><div class="p-4 border-t bg-gray-100 text-right"><button onclick="APP.actions.saveConfig()" class="bg-orange-600 text-white px-6 py-2 rounded font-bold shadow">保存</button></div></div></div>
    <div id="modal-batch-move" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-backdrop no-print"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6 animate-fade-in"><h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-exchange-alt text-yellow-500"></i> 批量调班</h3><p class="text-sm text-gray-500 mb-4">已选择 <span id="batch-move-count" class="font-bold text-blue-600">0</span> 名学生，请选择目标班级：</p><select id="batch-target-class" class="w-full p-2 border rounded mb-6 bg-gray-50"><option value="">-- 请选择目标班级 --</option></select><div class="flex justify-end gap-3"><button onclick="APP.ui.closeModal('modal-batch-move')" class="px-4 py-2 bg-gray-100 rounded text-gray-600 font-bold hover:bg-gray-200">取消</button><button onclick="APP.actions.executeBatchMove()" class="px-4 py-2 bg-yellow-500 text-white rounded font-bold hover:bg-yellow-600 shadow">确认调动</button></div></div></div>
    <div id="modal-student" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 overflow-hidden flex flex-col max-h-[90vh] animate-fade-in">
            <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                <h3 id="modal-student-title" class="font-bold text-lg"><i class="fas fa-user-graduate mr-2"></i> 学生详细档案</h3>
                <button onclick="APP.ui.closeModal('modal-student')" class="hover:bg-white/20 rounded p-1"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-gray-50" id="student-modal-body">
                <form id="form-student" class="space-y-6">
                    <input type="hidden" id="student-id"> <!-- 关键：隐藏ID用于区分添加/编辑 -->
                    
                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <h4 class="text-sm font-bold text-blue-600 uppercase mb-3 border-b pb-1">基本资料</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">班级</label><input type="text" id="std-class-display" class="w-full p-2 bg-gray-100 border rounded mt-1" disabled></div>
                            <div><label class="text-xs font-bold text-gray-500">学号</label><input type="text" id="std-no" class="w-full p-2 border rounded mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-500">入学日期</label><input type="date" id="std-join-date" class="w-full p-2 border rounded mt-1"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div><label class="text-xs font-bold text-gray-500">中文姓名</label><input type="text" id="std-name-ch" required class="w-full p-2 border rounded mt-1 font-bold text-lg"></div>
                            <div><label class="text-xs font-bold text-gray-500">英文姓名</label><input type="text" id="std-name-en" class="w-full p-2 border rounded mt-1 uppercase"></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <h4 class="text-sm font-bold text-blue-600 uppercase mb-3 border-b pb-1">身份证明</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">身份证号 (12位)</label><input type="text" id="std-ic" required maxlength="12" class="w-full p-2 border rounded mt-1 font-mono"></div>
                            <div><label class="text-xs font-bold text-gray-500">出生日期</label><input type="date" id="std-dob" class="w-full p-2 border rounded mt-1"></div>
                            <div><label class="text-xs font-bold text-gray-500">性别</label><select id="std-gender" class="w-full p-2 border rounded mt-1"><option>男</option><option>女</option></select></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div><label class="text-xs font-bold text-gray-500">报生纸号码</label><input type="text" id="std-birth-cert" class="w-full p-2 border rounded mt-1 uppercase"></div>
                            <div><label class="text-xs font-bold text-gray-500">出生地</label><input type="text" id="std-birth-place" class="w-full p-2 border rounded mt-1"></div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                        <h4 class="text-sm font-bold text-blue-600 uppercase mb-3 border-b pb-1">背景资料</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-gray-500">种族</label><select id="std-race" class="w-full p-2 border rounded mt-1"><option value="">-- 请选择 --</option></select></div>
                            <div><label class="text-xs font-bold text-gray-500">宗教</label><select id="std-religion" class="w-full p-2 border rounded mt-1"><option value="">-- 请选择 --</option></select></div>
                        </div>
                        <div class="mt-3"><label class="text-xs font-bold text-gray-500">地址</label><textarea id="std-address" rows="2" class="w-full p-2 border rounded mt-1"></textarea></div>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t bg-gray-100 flex justify-end gap-3">
                <button onclick="APP.ui.closeModal('modal-student')" class="px-5 py-2 bg-gray-200 rounded-lg text-gray-700 font-bold hover:bg-gray-300">取消</button>
                <button type="button" onclick="APP.actions.saveStudent()" class="px-6 py-2 bg-blue-600 rounded-lg text-white font-bold hover:bg-blue-700 shadow-lg">保存档案</button>
            </div>
        </div>
    </div>

    <!-- 权限编辑 & 我的权限 -->
    <div id="modal-edit-perms" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop no-print"><div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6"><h3 class="font-bold mb-4">修改权限</h3><p id="edit-perm-target-id" class="hidden"></p><form id="form-edit-perms" class="space-y-3"><label class="flex items-center"><input type="checkbox" name="perms" value="student_data" class="mr-2">学生资料</label><label class="flex items-center"><input type="checkbox" name="perms" value="account_manage" class="mr-2">账号管理</label><label class="flex items-center"><input type="checkbox" name="perms" value="perm_manage" class="mr-2">权限分配</label><label class="flex items-center"><input type="checkbox" name="perms" value="data_config" class="mr-2">资料设定</label><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="APP.ui.closeModal('modal-edit-perms')" class="px-3 py-1 bg-gray-200 rounded">取消</button><button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">保存</button></div></form></div></div>
    <div id="modal-my-perms" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop no-print"><div class="bg-white rounded-xl p-6 w-80"><h3 class="font-bold mb-4">我的权限</h3><div id="modal-my-id" class="text-sm text-gray-500 mb-2"></div><div id="modal-my-perm-list" class="space-y-2"></div><button onclick="APP.ui.closeModal('modal-my-perms')" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 py-2 rounded">关闭</button></div></div>
    <div id="debug-console" class="fixed bottom-0 left-0 w-full bg-slate-900 text-red-400 p-2 text-xs font-mono z-[100] hidden opacity-90 no-print"><div class="flex justify-between"><span class="font-bold">SYSTEM ERROR</span><button onclick="this.parentElement.parentElement.classList.add('hidden')" class="text-white bg-white/20 px-2 rounded">X</button></div><pre id="debug-content" class="mt-1 whitespace-pre-wrap"></pre></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, deleteDoc, updateDoc, onSnapshot, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const CONFIG = { appPath: 'ischool-v1', registry: 'schools_registry', firebase: { apiKey: "AIzaSyBZPY533p6K7md9qzlNBGheYRouvonr1F0", authDomain: "ischool-613c2.firebaseapp.com", projectId: "ischool-613c2", storageBucket: "ischool-613c2.firebasestorage.app", messagingSenderId: "134866756486", appId: "1:134866756486:web:d55e797b112e3465b74207" } };
        const STATE = { app: null, auth: null, db: null, user: null, schoolCode: null, schoolName: null, isGodMode: false, isSystemAdmin: false, maintenance: { active: false, msg: "", start: "", end: "" }, data: { users: [], classes: [], students: [], logs: [], allSchools: [] }, config: { races: ["华族", "巫族", "印族", "其他"], religions: ["佛教", "道教", "基督教", "天主教", "回教", "兴都教", "无", "其他"] }, refs: { users: null, logs: null, classes: null, students: null, options: null }, selectedClassId: null, selectedStudentIds: new Set(), attClassId: null, attDate: new Date().toISOString().split('T')[0], attData: {}, unsubscribers: [], timers: { idle: null, input: null } };

        const APP = {
            init: async () => {
                try {
                    STATE.app = initializeApp(CONFIG.firebase); STATE.auth = getAuth(STATE.app); STATE.db = getFirestore(STATE.app);
                    await signInAnonymously(STATE.auth);
                    const sysRef = doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/${CONFIG.registry}/SYSTEM`);
                    if(!(await getDoc(sysRef)).exists()){ await setDoc(sysRef, {name:"系统总控中心", code:"SYSTEM", createdAt:new Date().toISOString()}); await setDoc(doc(STATE.db, `artifacts/${CONFIG.appPath}/schools/SYSTEM/users/admin`), {id:'admin', pwd:'admin', role:'system_admin', permissions:['all']}); }
                    APP.system.listenToMaintenance();
                    APP.system.listenToAcademicYear();
                    document.getElementById('global-loading').classList.add('hidden');
                    APP.router.navigate('login'); APP.auth.initIdleTimer();
                } catch(e) { APP.ui.showError("初始化失败", e); }
            },
            data: {
                bindSchool: (schoolCode, type) => {
                    APP.data.clearListeners();
                    const root = `artifacts/${CONFIG.appPath}/schools/${schoolCode}`;
                    STATE.refs.users = collection(STATE.db, `${root}/users`);
                    STATE.refs.logs = collection(STATE.db, `${root}/logs`);
                    STATE.refs.classes = collection(STATE.db, `${root}/classes`);
                    STATE.refs.students = collection(STATE.db, `${root}/students`);
                    STATE.refs.options = doc(STATE.db, `${root}/settings/options`);
                    STATE.unsubscribers.push(onSnapshot(STATE.refs.users, (snap) => { STATE.data.users = []; snap.forEach(d => { let u=d.data(); if(!u.permissions) u.permissions=['student_data']; STATE.data.users.push(u); }); if(STATE.user && !STATE.isGodMode && type !== 'system') { const me = STATE.data.users.find(u => u.id === STATE.user.id); if(me) { STATE.user = me; APP.ui.updateHeader(); } } if(APP.router.current === 'admin') APP.ui.renderUserList(); }));
                    STATE.unsubscribers.push(onSnapshot(STATE.refs.classes, (snap) => { STATE.data.classes = []; snap.forEach(d => STATE.data.classes.push({...d.data(), id:d.id})); STATE.data.classes.sort((a,b) => String(a.year).localeCompare(String(b.year)) || String(a.name).localeCompare(String(b.name))); if(APP.router.current === 'student-data') APP.ui.renderStudentView(); if(APP.router.current === 'attendance') APP.ui.renderAttendanceView(); }));
                    STATE.unsubscribers.push(onSnapshot(STATE.refs.students, (snap) => { STATE.data.students = []; snap.forEach(d => STATE.data.students.push({...d.data(), id:d.id})); if(STATE.selectedClassId && APP.router.current === 'student-data') APP.ui.renderStudentList(); if(STATE.attClassId && APP.router.current === 'attendance') APP.ui.renderAttendanceList(); }));
                    STATE.unsubscribers.push(onSnapshot(STATE.refs.logs, (snap) => { STATE.data.logs = []; snap.forEach(d => STATE.data.logs.push({...d.data(), docId:d.id})); STATE.data.logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); if(APP.router.current === 'admin') APP.ui.renderLogs(); }));
                    STATE.unsubscribers.push(onSnapshot(STATE.refs.options, (snap) => { if(snap.exists()) STATE.config = snap.data(); if(!document.getElementById('modal-student').classList.contains('hidden')) APP.ui.populateDropdowns(); }));
                    if (type === 'system') { const regCol = collection(STATE.db, `artifacts/${CONFIG.appPath}/public/data/${CONFIG.registry}`); STATE.unsubscribers.push(onSnapshot(regCol, (snap) => { STATE.data.allSchools = []; snap.forEach(d => { if(d.id!=='SYSTEM') STATE.data.allSchools.push({...d.data(), id:d.id}); }); APP.ui.renderSystemSchoolList(); })); APP.system.loadSettingsForUI(); }
                },
                clearListeners: () => { STATE.unsubscribers.forEach(unsub => unsub()); STATE.unsubscribers = []; STATE.data = { users: [], classes: [], students: [], logs: [], allSchools: [] }; STATE.selectedClassId = null; STATE.selectedStudentIds.clear(); STATE.attClassId = null; STATE.attData = {}; },
                log: async (action) => { if(STATE.user) try { await addDoc(STATE.refs.logs, {user: STATE.user.id, action, timestamp: new Date().toISOString(), displayTime: new Date().toLocaleString()}); } catch(e){} },
                clearLogs: async () => { if(confirm("清空日志？")) { const q = await getDocs(STATE.refs.logs); const batch = writeBatch(STATE.db); q.forEach(d => batch.delete(d.ref)); await batch.commit(); } }
            },
            system: {
                listenToMaintenance: () => onSnapshot(doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/system_settings/config`), (snap) => { if(snap.exists()) { STATE.maintenance = snap.data(); APP.system.checkMaintenanceEnforcement(); } }),
                listenToAcademicYear: () => onSnapshot(doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/system_settings/academic_year`), (snap) => { if(snap.exists()) STATE.academicYear = snap.data(); }),
                checkMaintenanceEnforcement: () => { const { active, start, end, msg } = STATE.maintenance; const now = new Date().toISOString(); const isMaintTime = active && now >= start && now <= end; const banner = document.getElementById('login-maintenance-alert'); if(active && banner) { banner.classList.remove('hidden'); document.getElementById('login-maintenance-msg').innerText = `${msg}`; } else if (banner) banner.classList.add('hidden'); if (isMaintTime && STATE.user && !STATE.isSystemAdmin && STATE.schoolCode !== 'SYSTEM') { document.getElementById('maintenance-overlay').classList.remove('hidden'); document.getElementById('maintenance-msg-overlay').innerText = msg; APP.data.clearListeners(); STATE.user = null; } },
                saveSettings: async (e) => { e.preventDefault(); if(!STATE.isSystemAdmin) return; await setDoc(doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/system_settings/config`), { msg: document.getElementById('maint-msg').value, start: document.getElementById('maint-start').value, end: document.getElementById('maint-end').value, active: document.getElementById('maint-active').checked }); alert("已更新"); },
                saveAcademicYear: async (e) => { e.preventDefault(); if(!STATE.isSystemAdmin) return; await setDoc(doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/system_settings/academic_year`), { name: document.getElementById('sys-ay-name').value, start: document.getElementById('sys-ay-start').value, end: document.getElementById('sys-ay-end').value }); alert("学年设置已更新"); },
                loadSettingsForUI: async () => { if(!STATE.isSystemAdmin) return; const snap = await getDoc(doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/system_settings/config`)); if(snap.exists()) { const s = snap.data(); document.getElementById('maint-msg').value = s.msg||""; document.getElementById('maint-start').value = s.start||""; document.getElementById('maint-end').value = s.end||""; document.getElementById('maint-active').checked = s.active||false; } const aySnap = await getDoc(doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/system_settings/academic_year`)); if(aySnap.exists()) { const a = aySnap.data(); document.getElementById('sys-ay-name').value = a.name||""; document.getElementById('sys-ay-start').value = a.start||""; document.getElementById('sys-ay-end').value = a.end||""; } }
            },
            auth: {
                login: async (e) => { e.preventDefault(); const code = document.getElementById('login-school-code').value.trim().toUpperCase(); const id = document.getElementById('login-id').value.trim(); const pwd = document.getElementById('login-pwd').value.trim(); const { active, start, end } = STATE.maintenance; const now = new Date().toISOString(); if (active && now >= start && now <= end && code !== 'SYSTEM') return alert(`维护中: ${STATE.maintenance.msg}`); const btn = document.getElementById('btn-login-submit'); btn.disabled = true; btn.innerHTML = '验证中...'; document.getElementById('login-error').classList.add('hidden'); try { const sRef = doc(STATE.db, `artifacts/${CONFIG.appPath}/public/data/${CONFIG.registry}/${code}`); const sSnap = await getDoc(sRef); if(!sSnap.exists()) throw new Error("学校编号不存在"); const uRef = doc(STATE.db, `artifacts/${CONFIG.appPath}/schools/${code}/users/${id}`); const uSnap = await getDoc(uRef); if(!uSnap.exists() || uSnap.data().pwd !== pwd) throw new Error("用户名或密码错误"); STATE.user = uSnap.data(); if(!STATE.user.permissions) STATE.user.permissions = STATE.user.role==='admin'?['student_data','account_manage','perm_manage','data_config']:['student_data']; STATE.schoolCode = code; STATE.schoolName = sSnap.data().name; if(code === 'SYSTEM' && STATE.user.role === 'system_admin') { STATE.isSystemAdmin = true; APP.data.bindSchool('SYSTEM', 'system'); APP.router.navigate('system-console'); } else { STATE.isSystemAdmin = false; APP.data.bindSchool(code, 'school'); APP.router.navigate('dashboard'); } setTimeout(()=>APP.data.log('登录系统'),1000); document.getElementById('form-login').reset(); APP.ui.updateHeader(); } catch(err) { const errDiv = document.getElementById('login-error'); errDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + err.message; errDiv.classList.remove('hidden'); } finally { btn.disabled = false; btn.innerHTML = '<span>进入系统</span> <i class="fas fa-arrow-right"></i>'; } },
                logout: () => location.reload(),
                checkSchoolCode: (val) => { if(val.length<4)return; clearTimeout(STATE.timers.input); STATE.timers.input = setTimeout(async()=>{ try{ const ref=doc(STATE.db,`artifacts/${CONFIG.appPath}/public/data/${CONFIG.registry}/${val.toUpperCase()}`); const snap=await getDoc(ref); document.getElementById('school-name-display').innerHTML = snap.exists() ? `<span class='text-green-600'>${snap.data().name}</span>` : `<span class='text-red-400'>编号不存在</span>`; document.getElementById('school-name-display').style.opacity='1'; }catch(e){} },500); },
                initIdleTimer: () => { const reset = () => { if(STATE.user) { clearTimeout(STATE.timers.idle); STATE.timers.idle = setTimeout(() => { alert("闲置自动登出"); APP.auth.logout(); }, 10*60*1000); }}; ['mousemove','click','keypress'].forEach(e=>document.addEventListener(e,reset)); },
                enterGodMode: (c,n) => { STATE.isGodMode=true; STATE.schoolCode=c; STATE.schoolName=n; APP.data.bindSchool(c,'school'); document.getElementById('navbar').classList.add('bg-yellow-600'); document.getElementById('btn-god-mode-exit').classList.remove('hidden'); APP.router.navigate('dashboard'); APP.ui.updateHeader(); },
                exitGodMode: () => { STATE.isGodMode=false; STATE.schoolCode='SYSTEM'; STATE.schoolName='系统总控'; APP.data.bindSchool('SYSTEM','system'); document.getElementById('navbar').classList.remove('bg-yellow-600'); document.getElementById('btn-god-mode-exit').classList.add('hidden'); APP.router.navigate('system-console'); APP.ui.updateHeader(); }
            },
            router: { current: 'login', navigate: (view) => { APP.router.current = view; ['view-login', 'view-system-console', 'view-dashboard', 'view-admin', 'view-student-data', 'view-attendance'].forEach(v => document.getElementById(v).classList.add('hidden')); document.getElementById('navbar').classList.add('hidden'); if(view === 'login') document.getElementById('view-login').classList.remove('hidden'); else { document.getElementById('navbar').classList.remove('hidden'); document.getElementById(`view-${view}`).classList.remove('hidden'); if(view === 'dashboard') APP.ui.renderDashboard(); if(view === 'admin') { APP.ui.renderUserList(); APP.ui.renderLogs(); } if(view === 'student-data') APP.ui.renderStudentView(); if(view === 'attendance') APP.ui.renderAttendanceView(); } } },
            ui: {
                updateHeader: () => { if(STATE.user) { document.getElementById('nav-user-id').innerText = STATE.user.id + (STATE.isGodMode?'(上帝)':''); document.getElementById('nav-school-name').innerText = STATE.schoolName; } },
                renderDashboard: () => { 
                    const c = document.getElementById('dashboard-card-container'); c.innerHTML = ''; document.getElementById('dashboard-school-name').innerText = STATE.schoolName; 
                    const perms = STATE.isGodMode ? ['student_data','account_manage','perm_manage','data_config','attendance'] : (STATE.user.permissions || []); 
                    if(perms.includes('student_data')) c.innerHTML += `<div onclick="APP.router.navigate('student-data')" class="dashboard-card bg-white rounded-xl p-8 shadow-sm cursor-pointer border border-gray-100 flex flex-col items-center text-center group"><div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mb-6 group-hover:bg-blue-100 transition"><i class="fas fa-user-graduate text-3xl text-blue-600"></i></div><h3 class="text-xl font-bold text-gray-800 mb-2">学生资料库</h3><p class="text-sm text-gray-500">管理本校学生档案信息</p></div>`; 
                    if(perms.includes('student_data')) c.innerHTML += `<div onclick="APP.router.navigate('attendance')" class="dashboard-card bg-white rounded-xl p-8 shadow-sm cursor-pointer border border-gray-100 flex flex-col items-center text-center group"><div class="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mb-6 group-hover:bg-green-100 transition"><i class="fas fa-clipboard-check text-3xl text-green-600"></i></div><h3 class="text-xl font-bold text-gray-800 mb-2">班级点名</h3><p class="text-sm text-gray-500">每日学生出勤记录</p></div>`;
                    if(perms.includes('account_manage') || perms.includes('perm_manage')) c.innerHTML += `<div onclick="APP.router.navigate('admin')" class="dashboard-card bg-white rounded-xl p-8 shadow-sm cursor-pointer border border-gray-100 flex flex-col items-center text-center group"><div class="w-20 h-20 bg-purple-50 rounded-full flex items-center justify-center mb-6 group-hover:bg-purple-100 transition"><i class="fas fa-cogs text-3xl text-purple-600"></i></div><h3 class="text-xl font-bold text-gray-800 mb-2">本校后台管理</h3><p class="text-sm text-gray-500">账号权限与系统日志</p></div>`; 
                },
                renderUserList: () => { const tb = document.getElementById('user-list-body'); tb.innerHTML = ''; STATE.data.users.forEach(u => { const perms = (u.permissions||[]).map(p => `<span class="text-[10px] bg-gray-100 text-gray-700 px-1 rounded mr-1">${p.split('_')[0]}</span>`).join(''); let actions = (STATE.isGodMode || (STATE.user.permissions||[]).includes('account_manage')) && u.id!=='admin' ? `<button onclick="APP.actions.deleteUser('${u.id}')" class="text-red-500"><i class="fas fa-trash"></i></button>` : ''; if((STATE.isGodMode || (STATE.user.permissions||[]).includes('perm_manage')) && u.id!=='admin') actions = `<button onclick="APP.ui.openPermModal('${u.id}')" class="text-blue-500 mr-2"><i class="fas fa-cog"></i></button>` + actions; tb.innerHTML += `<tr class="border-b"><td class="px-6 py-3">${u.id}</td><td class="px-6 py-3">${perms}</td><td class="px-6 py-3">***</td><td class="px-6 py-3 text-right">${actions}</td></tr>`; }); },
                renderLogs: () => { const c = document.getElementById('log-container'); c.innerHTML = ''; if(STATE.data.logs.length===0) c.innerHTML = '<div class="text-center text-gray-400 py-10">暂无日志</div>'; STATE.data.logs.forEach(l => { let color = 'text-gray-600', icon='circle'; if(l.action.includes('登录')) { color='text-green-600'; icon='sign-in-alt'; } else if(l.action.includes('创建') || l.action.includes('添加')) { color='text-blue-600'; icon='plus'; } else if(l.action.includes('删除')) { color='text-red-600'; icon='trash'; } c.innerHTML += `<div class="flex items-start gap-3 p-2 rounded text-xs border-b"><div class="mt-0.5 ${color}"><i class="fas fa-${icon}"></i></div><div class="flex-1"><div class="flex justify-between"><span class="font-bold">${l.user}</span><span class="text-gray-400">${l.displayTime}</span></div><p class="${color}">${l.action}</p></div></div>`; }); },
                renderSystemSchoolList: () => { const t = document.getElementById('system-school-list'); t.innerHTML = ''; STATE.data.allSchools.forEach(s => t.innerHTML += `<tr class="border-b"><td class="px-4 py-3 font-mono text-blue-600">${s.code}</td><td class="px-4 py-3">${s.name}</td><td class="px-4 py-3 text-right"><button onclick="APP.auth.enterGodMode('${s.code}', '${s.name}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-xs mr-2">进入</button><button onclick="APP.actions.deleteSchool('${s.code}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`); },
                renderStudentView: () => { const p = STATE.user.permissions || []; if(p.includes('data_config') || STATE.isGodMode) document.getElementById('btn-config-data').classList.remove('hidden'); else document.getElementById('btn-config-data').classList.add('hidden'); if(STATE.user.role==='admin' || STATE.isGodMode) document.getElementById('btn-manage-classes').classList.remove('hidden'); else document.getElementById('btn-manage-classes').classList.add('hidden'); const l = document.getElementById('class-list-container'); l.innerHTML=''; STATE.data.classes.forEach(c => { const act = c.id === STATE.selectedClassId ? 'active bg-blue-50 text-blue-700 font-bold' : 'hover:bg-gray-50 text-gray-600'; l.innerHTML += `<div onclick="APP.actions.selectClass('${c.id}')" class="class-btn p-3 m-1 rounded cursor-pointer flex justify-between ${act}"><span>${c.year} ${c.name}</span></div>`; }); if(STATE.selectedClassId) APP.ui.renderStudentList(); },
                renderStudentList: () => { 
                    const t = document.getElementById('student-list-body'); 
                    const cls = STATE.data.classes.find(c => c.id === STATE.selectedClassId); 
                    if(!cls) { STATE.selectedClassId=null; return APP.ui.renderStudentView(); } 
                    document.getElementById('current-class-title').innerText = `${cls.year} - ${cls.name}`; 
                    document.getElementById('current-class-info').innerText = cls.id; 
                    document.getElementById('btn-add-student').classList.remove('hidden'); 
                    document.getElementById('btn-print-list').classList.remove('hidden'); 
                    document.getElementById('btn-batch-move').classList.remove('hidden');
                    
                    // Filter
                    const ss = STATE.data.students.filter(s => s.classId === STATE.selectedClassId); 
                    // Sort by English Name A-Z
                    ss.sort((a, b) => {
                        const na = (a.name_en || "").trim().toLowerCase();
                        const nb = (b.name_en || "").trim().toLowerCase();
                        return na.localeCompare(nb);
                    });

                    document.getElementById('student-count').innerText = ss.length; 
                    t.innerHTML = ''; 
                    if(ss.length===0) t.innerHTML='<tr><td colspan="5" class="text-center py-10 text-gray-400">暂无学生</td></tr>'; 
                    const updateSelectionUI = () => { const count = STATE.selectedStudentIds.size; const disp = document.getElementById('selected-count-display'); if(count > 0) { disp.innerText = `已选: ${count} 人`; disp.classList.remove('hidden'); } else { disp.classList.add('hidden'); } }; ss.forEach(s => { const isChecked = STATE.selectedStudentIds.has(s.id) ? 'checked' : ''; t.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 text-center"><input type="checkbox" class="custom-checkbox" onchange="APP.actions.toggleStudentSelection('${s.id}', this.checked)" ${isChecked}></td><td class="px-6 py-3"><div>${s.name_ch}</div><div class="text-xs text-gray-400">${s.name_en||''}</div><div class="text-xs text-gray-400">${s.std_no||'-'}</div></td><td class="px-6 py-3">${s.gender}<br><span class="text-xs text-gray-400">${s.race||'-'}</span></td><td class="px-6 py-3 font-mono">${s.ic}</td><td class="px-6 py-3 text-right"><button onclick="APP.ui.openStudentModal('${s.id}')" class="text-blue-500 mr-2"><i class="fas fa-edit"></i></button><button onclick="APP.actions.deleteStudent('${s.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></td></tr>`; }); updateSelectionUI(); 
                },
                // Attendance UI
                renderAttendanceView: () => {
                    const l = document.getElementById('att-class-list'); l.innerHTML='';
                    STATE.data.classes.forEach(c => {
                        const act = c.id === STATE.attClassId ? 'active bg-blue-50 text-blue-700 font-bold' : 'hover:bg-gray-50 text-gray-600';
                        l.innerHTML += `<div onclick="APP.attendance.selectClass('${c.id}')" class="class-btn p-3 m-1 rounded cursor-pointer flex justify-between ${act}"><span>${c.year} ${c.name}</span></div>`;
                    });
                    document.getElementById('att-date-picker').value = STATE.attDate;
                    if(STATE.attClassId) APP.ui.renderAttendanceList();
                },
                renderAttendanceList: async () => {
                    const t = document.getElementById('att-student-list');
                    const cls = STATE.data.classes.find(c => c.id === STATE.attClassId);
                    if(!cls) { 
                        t.innerHTML = '<tr><td colspan="3" class="text-center py-20 text-gray-400">请选择班级</td></tr>';
                        return; 
                    }
                    
                    document.getElementById('att-class-title').innerText = `${cls.year} - ${cls.name}`;
                    document.getElementById('btn-save-attendance').classList.remove('hidden');
                    document.getElementById('btn-print-att').classList.remove('hidden');

                    const ss = STATE.data.students.filter(s => s.classId === STATE.attClassId);
                    ss.sort((a, b) => (a.name_en || "").trim().toLowerCase().localeCompare((b.name_en || "").trim().toLowerCase()));

                    t.innerHTML = '';
                    if(ss.length===0) t.innerHTML='<tr><td colspan="3" class="text-center py-20 text-gray-400">暂无学生</td></tr>';

                    let stats = { present: 0, absent: 0, late: 0, excused: 0 };
                    const record = STATE.attData || {};

                    ss.forEach((s, i) => {
                        const status = record[s.id] || 'present'; // Default to present
                        stats[status]++;
                        
                        t.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-mono text-gray-500 text-center">${i+1}</td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-700">${s.name_ch}</div>
                                <div class="text-xs text-gray-400">${s.name_en}</div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="APP.attendance.setStatus('${s.id}', 'present')" class="att-btn att-present ${status==='present'?'selected':''} text-green-600 hover:bg-green-50">出席</button>
                                    <button onclick="APP.attendance.setStatus('${s.id}', 'absent')" class="att-btn att-absent ${status==='absent'?'selected':''} text-red-600 hover:bg-red-50">缺席</button>
                                    <button onclick="APP.attendance.setStatus('${s.id}', 'late')" class="att-btn att-late ${status==='late'?'selected':''} text-orange-600 hover:bg-orange-50">迟到</button>
                                    <button onclick="APP.attendance.setStatus('${s.id}', 'excused')" class="att-btn att-excused ${status==='excused'?'selected':''} text-blue-600 hover:bg-blue-50">请假</button>
                                </div>
                            </td>
                        </tr>`;
                    });
                    
                    document.getElementById('att-summary').innerHTML = `出席: ${stats.present} | 缺席: ${stats.absent} | 迟到: ${stats.late} | 请假: ${stats.excused}`;
                },

                populateDropdowns: () => { const races = (STATE.config && STATE.config.races) ? STATE.config.races : ["华族","巫族","印族","其他"]; const religions = (STATE.config && STATE.config.religions) ? STATE.config.religions : ["佛教","道教","基督教","天主教","回教","兴都教","无"]; const rSel = document.getElementById('std-race'); rSel.innerHTML = '<option value="">-- 请选择 --</option>'; races.forEach(r => rSel.innerHTML += `<option value="${r}">${r}</option>`); const relSel = document.getElementById('std-religion'); relSel.innerHTML = '<option value="">-- 请选择 --</option>'; religions.forEach(r => relSel.innerHTML += `<option value="${r}">${r}</option>`); },
                renderConfigList: (type) => { const c = document.getElementById(`list-${type}`); c.innerHTML = ''; const list = (STATE.config && STATE.config[type]) ? STATE.config[type] : []; list.forEach(item => { c.innerHTML += `<div class="tag-item"><span>${item}</span><i onclick="APP.actions.removeConfigOption('${type}', '${item}')" class="fas fa-times tag-remove"></i></div>`; }); },
                openClassModal: () => { 
                    document.getElementById('modal-classes').classList.remove('hidden'); 
                    if(STATE.academicYear && STATE.academicYear.name) { const yearInput = document.getElementById('input-class-year'); yearInput.value = STATE.academicYear.name; yearInput.readOnly = true; yearInput.classList.add('bg-gray-100'); }
                    APP.ui.renderManageClassList();
                },
                openEditClassModal: (cid) => {
                    const cls = STATE.data.classes.find(c => c.id === cid);
                    document.getElementById('edit-class-id').value = cls.id;
                    document.getElementById('edit-class-name').value = cls.name;
                    const sel = document.getElementById('edit-class-teacher');
                    sel.innerHTML = '<option value="">-- 无 --</option>';
                    STATE.data.users.forEach(u => { if(u.role !== 'system_admin') { sel.innerHTML += `<option value="${u.id}">${u.id}</option>`; } });
                    sel.value = cls.formTeacherId || "";
                    document.getElementById('modal-edit-class').classList.remove('hidden');
                },
                openStudentModal: (sid) => {
                    APP.ui.populateDropdowns();
                    if(!STATE.selectedClassId) return alert("请选班级");
                    const cls = STATE.data.classes.find(c => c.id === STATE.selectedClassId);
                    document.getElementById('std-class-display').value = `${cls.year} ${cls.name}`;
                    const body = document.getElementById('student-modal-body'); if(body) body.scrollTop = 0;
                    if(sid) {
                        const s = STATE.data.students.find(x => x.id === sid);
                        if(!s) return alert("数据未找到");
                        document.getElementById('student-id').value = s.id;
                        document.getElementById('modal-student-title').innerHTML = '<i class="fas fa-edit mr-2"></i> 编辑学生资料';
                        const setValue = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
                        setValue('std-no', s.std_no); setValue('std-join-date', s.join_date); setValue('std-name-ch', s.name_ch); setValue('std-name-en', s.name_en); setValue('std-ic', s.ic); setValue('std-dob', s.dob); setValue('std-gender', s.gender); setValue('std-birth-cert', s.birth_cert); setValue('std-birth-place', s.birth_place); setValue('std-race', s.race); setValue('std-religion', s.religion); setValue('std-address', s.address);
                    } else {
                        document.getElementById('form-student').reset();
                        document.getElementById('student-id').value = ''; 
                        document.getElementById('modal-student-title').innerHTML = '<i class="fas fa-plus mr-2"></i> 添加新学生';
                        document.getElementById('std-gender').value = '男';
                        document.getElementById('std-class-display').value = `${cls.year} ${cls.name}`;
                    }
                    document.getElementById('modal-student').classList.remove('hidden');
                },
                openBatchMoveModal: () => {
                    if(STATE.selectedStudentIds.size === 0) return alert("请至少选择一名学生");
                    const sel = document.getElementById('batch-target-class');
                    sel.innerHTML = '<option value="">-- 请选择目标班级 --</option>';
                    STATE.data.classes.forEach(c => { if(c.id !== STATE.selectedClassId) sel.innerHTML += `<option value="${c.id}">${c.year} ${c.name}</option>`; });
                    document.getElementById('batch-move-count').innerText = STATE.selectedStudentIds.size;
                    document.getElementById('modal-batch-move').classList.remove('hidden');
                },
                openConfigModal: () => { document.getElementById('modal-data-config').classList.remove('hidden'); APP.ui.renderConfigList('races'); APP.ui.renderConfigList('religions'); },
                openPermModal: (uid) => { const u = STATE.data.users.find(x=>x.id===uid); document.getElementById('edit-perm-target-id').innerText=uid; document.getElementById('modal-edit-perms').classList.remove('hidden'); document.querySelectorAll('input[name="perms"]').forEach(cb => cb.checked=(u.permissions||[]).includes(cb.value)); },
                showMyPermissions: () => { if(!STATE.user) return; document.getElementById('modal-my-id').innerText = STATE.user.id; const c = document.getElementById('modal-my-perm-list'); c.innerHTML=''; (STATE.user.permissions||[]).forEach(p=>c.innerHTML+=`<div class="p-2 bg-gray-100 rounded text-sm mb-1">${p}</div>`); document.getElementById('modal-my-perms').classList.remove('hidden'); },
                closeModal: (id) => document.getElementById(id).classList.add('hidden'),
                showError: (msg,e) => { console.error(msg,e); document.getElementById('debug-console').classList.remove('hidden'); document.getElementById('debug-content').innerText=msg+": "+(e?.message||''); }
            },
            
            // === 打印模块 ===
            print: {
                openPrintPreview: () => {
                    if(!STATE.selectedClassId) return;
                    const cls = STATE.data.classes.find(c => c.id === STATE.selectedClassId);
                    const students = STATE.data.students.filter(s => s.classId === STATE.selectedClassId);
                    students.sort((a, b) => (a.name_en || "").trim().toLowerCase().localeCompare((b.name_en || "").trim().toLowerCase()));

                    let teacherName = "________________";
                    if(cls.formTeacherId) {
                        const t = STATE.data.users.find(u => u.id === cls.formTeacherId);
                        if(t) teacherName = t.id; 
                    }

                    let countL = 0, countP = 0;
                    students.forEach(s => { if(s.gender === '男') countL++; else countP++; });

                    let rowsHtml = '';
                    for(let i=0; i<40; i++) {
                        const s = students[i];
                        if(s) {
                            const genderCode = s.gender === '男' ? 'L' : 'P';
                            rowsHtml += `
                            <tr>
                                <td>${i+1}</td>
                                <td class="col-name-ch">${s.name_ch}</td>
                                <td class="col-name-en">${s.name_en}</td>
                                <td class="col-fit"></td>
                                <td class="col-fit">${genderCode}</td>
                                <td class="col-std-id">${s.std_no || ''}</td>
                                <td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td>
                            </tr>`;
                        } else {
                            rowsHtml += `
                            <tr>
                                <td>${i+1}</td><td></td><td></td><td class="col-fit"></td><td class="col-fit"></td><td class="col-std-id"></td>
                                <td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td><td class="col-record"></td>
                            </tr>`;
                        }
                    }

                    const printHtml = `
                        <div class="report-header">
                            <h2 class="report-school-name">${STATE.schoolName}</h2>
                        </div>
                        <div class="report-info-bar">
                            <div style="width: 30%; text-align: left;">班级: ${cls.name}</div>
                            <div style="width: 40%; text-align: center;">${cls.year} 年学生名单</div>
                            <div style="width: 30%; text-align: right;">班主任: ${teacherName}</div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr style="height: 30px;">
                                    <th class="col-fit">序号</th>
                                    <th class="col-name-ch">姓名</th>
                                    <th class="col-name-en">NAME</th>
                                    <th class="col-fit">保险</th>
                                    <th class="col-fit">性别</th>
                                    <th class="col-std-id">学号</th>
                                    <th class="col-record"></th><th class="col-record"></th><th class="col-record"></th><th class="col-record"></th><th class="col-record"></th><th class="col-record"></th><th class="col-record"></th><th class="col-record"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                        <div class="report-footer">
                            L=${countL} &nbsp;&nbsp; P=${countP} &nbsp;&nbsp; J=${countL + countP}
                        </div>
                    `;

                    document.getElementById('print-area').innerHTML = printHtml;
                    document.getElementById('print-preview-container').innerHTML = printHtml;
                    document.getElementById('modal-print').classList.remove('hidden');
                },

                openAttendancePrintPreview: async () => {
                    if(!STATE.attClassId) return alert("请先选择班级");
                    if(!STATE.attDate) return alert("请选择日期");

                    const cls = STATE.data.classes.find(c => c.id === STATE.attClassId);
                    const students = STATE.data.students.filter(s => s.classId === STATE.attClassId);
                    students.sort((a, b) => (a.name_en || "").trim().toLowerCase().localeCompare((b.name_en || "").trim().toLowerCase()));

                    // Calculate the 14 dates (ending with selected date)
                    const dates = [];
                    const selectedDate = new Date(STATE.attDate);
                    for (let i = 13; i >= 0; i--) { // 13 days before + today = 14 days
                        const d = new Date(selectedDate);
                        d.setDate(d.getDate() - i);
                        dates.push(d.toISOString().split('T')[0]);
                    }

                    // Fetch attendance data for these 14 dates
                    const fetchOne = async (dateStr) => {
                        const docId = `${STATE.attClassId}_${dateStr}`;
                        const ref = doc(STATE.db, `artifacts/${CONFIG.appPath}/schools/${STATE.schoolCode}/attendance/${docId}`);
                        try {
                            const snap = await getDoc(ref);
                            if (snap.exists()) return { date: dateStr, records: snap.data().records || {} };
                        } catch(e) {}
                        return { date: dateStr, records: {} };
                    };

                    const results = await Promise.all(dates.map(d => fetchOne(d)));
                    const dateRecords = {};
                    results.forEach(r => dateRecords[r.date] = r.records);

                    // Header construction
                    let dateHeaderHtml = '';
                    // SATURDAY letters: S-A-T-U-R-D-A-Y (8 chars)
                    // SUNDAY letters: S-U-N-D-A-Y (6 chars)
                    const satLetters = ['S','A','T','U','R','D','A','Y'];
                    const sunLetters = ['S','U','N','D','A','Y'];

                    dates.forEach(d => {
                        const parts = d.split('-');
                        dateHeaderHtml += `<th class="col-date">${parts[2]}/${parts[1]}</th>`;
                    });

                    // Build Rows
                    let rowsHtml = '';
                    for(let i=0; i<40; i++) {
                        const s = students[i];
                        if(s) {
                            let attCells = '';
                            dates.forEach(d => {
                                const dateObj = new Date(d);
                                const dayIdx = dateObj.getDay(); // 0=Sun, 6=Sat
                                const isSat = dayIdx === 6;
                                const isSun = dayIdx === 0;

                                if (isSat) {
                                    // Loop Saturday letters
                                    const char = satLetters[i % satLetters.length];
                                    attCells += `<td class="cell-weekend" style="font-size:10px; font-weight:bold;">${char}</td>`;
                                } else if (isSun) {
                                    // Loop Sunday letters
                                    const char = sunLetters[i % sunLetters.length];
                                    attCells += `<td class="cell-weekend" style="font-size:10px; font-weight:bold;">${char}</td>`;
                                } else {
                                    // Weekday Logic
                                    const status = dateRecords[d][s.id]; // May be undefined if no record
                                    let symbol = '/'; // Default present
                                    
                                    if (status === 'absent') symbol = 'O';
                                    else if (status === 'late') symbol = 'L';
                                    else if (status === 'excused') symbol = 'E';
                                    // If status is undefined or 'present', symbol remains '/'
                                    
                                    attCells += `<td>${symbol}</td>`;
                                }
                            });

                            rowsHtml += `
                            <tr>
                                <td>${i+1}</td>
                                <td class="col-name-ch">${s.name_ch}</td>
                                <td class="col-name-en">${s.name_en}</td>
                                <td class="col-fit">${s.gender === '男' ? 'L' : 'P'}</td>
                                ${attCells}
                            </tr>`;
                        } else {
                            let emptyCells = '';
                            for(let k=0; k<14; k++) {
                                // Still render letters for empty rows on weekends?
                                const d = dates[k];
                                const dateObj = new Date(d);
                                const dayIdx = dateObj.getDay();
                                const isSat = dayIdx === 6;
                                const isSun = dayIdx === 0;
                                
                                if(isSat) {
                                     const char = satLetters[i % satLetters.length];
                                     emptyCells += `<td class="cell-weekend" style="font-size:10px; font-weight:bold;">${char}</td>`;
                                } else if (isSun) {
                                     const char = sunLetters[i % sunLetters.length];
                                     emptyCells += `<td class="cell-weekend" style="font-size:10px; font-weight:bold;">${char}</td>`;
                                } else {
                                     emptyCells += `<td></td>`;
                                }
                            }
                            rowsHtml += `
                            <tr>
                                <td>${i+1}</td><td></td><td></td><td></td>
                                ${emptyCells}
                            </tr>`;
                        }
                    }

                    let teacherName = "________________";
                    if(cls.formTeacherId) {
                        const t = STATE.data.users.find(u => u.id === cls.formTeacherId);
                        if(t) teacherName = t.id; 
                    }

                    const printHtml = `
                        <div class="report-header">
                            <h2 class="report-school-name">${STATE.schoolName}</h2>
                        </div>
                        <div class="report-info-bar">
                            <div style="width: 30%; text-align: left;">班级: ${cls.name}</div>
                            <div style="width: 40%; text-align: center;">${cls.year} 年学生点名记录</div>
                            <div style="width: 30%; text-align: right;">班主任: ${teacherName}</div>
                        </div>
                        <table class="report-table">
                            <thead>
                                <tr style="height: 30px;">
                                    <th class="col-fit">序号</th>
                                    <th class="col-name-ch">姓名</th>
                                    <th class="col-name-en">NAME</th>
                                    <th class="col-fit">性别</th>
                                    ${dateHeaderHtml}
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                        <div class="report-footer" style="margin-top:10px;">
                            / : 出席 &nbsp; O : 缺席 &nbsp; L : 迟到 &nbsp; E : 请假
                        </div>
                    `;

                    document.getElementById('print-area').innerHTML = printHtml;
                    document.getElementById('print-preview-container').innerHTML = printHtml;
                    document.getElementById('modal-print').classList.remove('hidden');
                }
            },

            // === 点名模块 ===
            attendance: {
                // Select Class: Trigger Fetch -> Update State -> Render View (Highlight) -> Fetch Students -> Render List
                selectClass: async (id) => { 
                    STATE.attClassId = id; 
                    APP.ui.renderAttendanceView(); // Immediate visual feedback (highlight sidebar)
                    
                    // Fetch Data for this class and date
                    const docId = `${STATE.attClassId}_${STATE.attDate}`;
                    const attRef = doc(STATE.db, `artifacts/${CONFIG.appPath}/schools/${STATE.schoolCode}/attendance/${docId}`);
                    let record = {};
                    try {
                        const snap = await getDoc(attRef);
                        if (snap.exists()) record = snap.data().records || {};
                    } catch(e) {}
                    STATE.attData = record;

                    APP.ui.renderAttendanceList();
                },
                
                // Change Date: Fetch Data -> Render List
                changeDate: async (newDate) => {
                    STATE.attDate = newDate;
                    if(!STATE.attClassId) return;

                    const docId = `${STATE.attClassId}_${STATE.attDate}`;
                    const attRef = doc(STATE.db, `artifacts/${CONFIG.appPath}/schools/${STATE.schoolCode}/attendance/${docId}`);
                    let record = {};
                    try {
                        const snap = await getDoc(attRef);
                        if (snap.exists()) record = snap.data().records || {};
                    } catch(e) {}
                    STATE.attData = record;
                    
                    APP.ui.renderAttendanceList();
                },

                setStatus: (sid, status) => {
                    STATE.attData[sid] = status;
                    APP.ui.renderAttendanceList(); // Sync render from local state
                },
                save: async () => {
                    if(!STATE.attClassId) return;
                    const date = document.getElementById('att-date-picker').value;
                    if(!date) return alert("请选择日期");
                    
                    // 自动填充默认出席
                    const students = STATE.data.students.filter(s => s.classId === STATE.attClassId);
                    students.forEach(s => {
                        if(!STATE.attData[s.id]) STATE.attData[s.id] = 'present';
                    });

                    const docId = `${STATE.attClassId}_${date}`;
                    const data = {
                        date: date,
                        classId: STATE.attClassId,
                        records: STATE.attData,
                        updatedBy: STATE.user.id,
                        updatedAt: new Date().toISOString()
                    };
                    
                    try {
                        await setDoc(doc(STATE.db, `artifacts/${CONFIG.appPath}/schools/${STATE.schoolCode}/attendance/${docId}`), data);
                        alert("点名保存成功");
                        APP.data.log(`点名: ${STATE.attClassId} (${date})`);
                        // 重新渲染以显示最新状态（虽然数据已经是present了，但在UI上确认一下也好）
                        APP.ui.renderAttendanceList(); 
                    } catch(e) { alert("保存失败"); }
                }
            },

            actions: {
                addUser: async(e)=>{ e.preventDefault(); const id=document.getElementById('new-user-id').value; const pwd=document.getElementById('new-user-pwd').value; try{ await setDoc(doc(STATE.refs.users,id),{id,pwd,role:'teacher',permissions:['student_data']}); document.getElementById('form-add-user').reset(); APP.data.log(`创建账号: ${id}`); }catch(e){alert("失败");} },
                deleteUser: async(id)=>{ if(confirm('删?')) await deleteDoc(doc(STATE.refs.users,id)); },
                savePerms: async(e)=>{ e.preventDefault(); const id=document.getElementById('edit-perm-target-id').innerText; const p=[]; document.querySelectorAll('input[name="perms"]:checked').forEach(c=>p.push(c.value)); await updateDoc(doc(STATE.refs.users,id),{permissions:p}); APP.ui.closeModal('modal-edit-perms'); },
                createSchool: async(e)=>{ e.preventDefault(); const n=document.getElementById('sys-school-name').value; const c=document.getElementById('sys-school-code').value.toUpperCase(); const p=document.getElementById('sys-admin-pwd').value; try{ await setDoc(doc(STATE.db,`artifacts/${CONFIG.appPath}/public/data/${CONFIG.registry}/${c}`),{name:n,code:c,createdAt:new Date().toISOString()}); await setDoc(doc(STATE.db,`artifacts/${CONFIG.appPath}/schools/${c}/users/admin`),{id:'admin',pwd:p,role:'admin',permissions:['student_data','account_manage','perm_manage','data_config']}); document.getElementById('form-create-school').reset(); alert("成功"); }catch(e){alert("失败");} },
                deleteSchool: async(c)=>{ if(confirm('删?')) await deleteDoc(doc(STATE.db,`artifacts/${CONFIG.appPath}/public/data/${CONFIG.registry}/${c}`)); },
                addClass: async(e)=>{ e.preventDefault(); await addDoc(STATE.refs.classes,{year:document.getElementById('input-class-year').value,name:document.getElementById('input-class-name').value}); document.getElementById('form-add-class').reset(); },
                deleteClass: async(id)=>{ if(confirm('删?')) await deleteDoc(doc(STATE.refs.classes,id)); },
                updateClass: async(id,old)=>{ document.getElementById('modal-classes').classList.add('hidden'); APP.ui.openEditClassModal(id); }, 
                saveEditedClass: async(e) => {
                    e.preventDefault();
                    const id = document.getElementById('edit-class-id').value;
                    const name = document.getElementById('edit-class-name').value;
                    const teacherId = document.getElementById('edit-class-teacher').value;
                    try {
                        await updateDoc(doc(STATE.refs.classes, id), { name: name, formTeacherId: teacherId });
                        APP.ui.closeModal('modal-edit-class');
                        APP.ui.openClassModal(); 
                    } catch(e) { alert("保存失败"); }
                },
                selectClass: (id)=>{ STATE.selectedClassId=id; STATE.selectedStudentIds.clear(); APP.ui.renderStudentView(); },
                saveStudent: async () => {
                    const sid = document.getElementById('student-id').value;
                    const data = { classId: STATE.selectedClassId, std_no: document.getElementById('std-no').value, join_date: document.getElementById('std-join-date').value, name_ch: document.getElementById('std-name-ch').value, name_en: document.getElementById('std-name-en').value, ic: document.getElementById('std-ic').value, dob: document.getElementById('std-dob').value, gender: document.getElementById('std-gender').value, birth_cert: document.getElementById('std-birth-cert').value, birth_place: document.getElementById('std-birth-place').value, race: document.getElementById('std-race').value, religion: document.getElementById('std-religion').value, address: document.getElementById('std-address').value, updatedBy: STATE.user.id, updatedAt: new Date().toISOString() };
                    if(data.ic && data.ic.length !== 12) return alert("身份证号码必须是12位数字");
                    try { if(sid && sid.trim() !== "") await updateDoc(doc(STATE.refs.students, sid), data); else await addDoc(STATE.refs.students, data); APP.ui.closeModal('modal-student'); APP.data.log(`档案: ${data.name_ch}`); } catch(e) { alert("保存失败"); console.error(e); }
                },
                deleteStudent: async(id)=>{ if(confirm('删?')) await deleteDoc(doc(STATE.refs.students,id)); },
                toggleSelectAll: (checked) => { const students = STATE.data.students.filter(s => s.classId === STATE.selectedClassId); if(checked) students.forEach(s => STATE.selectedStudentIds.add(s.id)); else STATE.selectedStudentIds.clear(); APP.ui.renderStudentList(); },
                toggleStudentSelection: (id, checked) => { if(checked) STATE.selectedStudentIds.add(id); else STATE.selectedStudentIds.delete(id); APP.ui.renderStudentList(); },
                executeBatchMove: async () => {
                    const targetClassId = document.getElementById('batch-target-class').value; if(!targetClassId) return alert("请选择目标班级");
                    const targetClass = STATE.data.classes.find(c => c.id === targetClassId);
                    if(!confirm(`确定将 ${STATE.selectedStudentIds.size} 名学生移动到 ${targetClass.year} ${targetClass.name} 吗？`)) return;
                    const batch = writeBatch(STATE.db); STATE.selectedStudentIds.forEach(sid => { const ref = doc(STATE.refs.students, sid); batch.update(ref, { classId: targetClassId }); });
                    try { await batch.commit(); APP.data.log(`批量调动 ${STATE.selectedStudentIds.size} 名学生`); STATE.selectedStudentIds.clear(); APP.ui.closeModal('modal-batch-move'); alert("调动成功"); } catch(e) { alert("调动失败"); }
                },
                addConfigOption: (type) => { const input = document.getElementById(`input-new-${type.slice(0,-1)}`); const val = input.value.trim(); if(!val) return; if(!STATE.config[type]) STATE.config[type] = []; if(STATE.config[type].includes(val)) return alert("已存在"); STATE.config[type].push(val); APP.ui.renderConfigList(type); input.value = ''; },
                removeConfigOption: (type, val) => { STATE.config[type] = STATE.config[type].filter(x => x !== val); APP.ui.renderConfigList(type); },
                saveConfig: async () => { try { await setDoc(STATE.refs.options, STATE.config); APP.ui.closeModal('modal-data-config'); alert("设定已保存"); APP.data.log("更新选项"); } catch(e) { alert("保存失败"); } }
            }
        };

        window.APP = APP;
        document.getElementById('form-login').onsubmit = APP.auth.login;
        document.getElementById('form-create-school').onsubmit = APP.actions.createSchool;
        document.getElementById('form-maintenance').onsubmit = APP.system.saveSettings;
        document.getElementById('form-academic-year').onsubmit = APP.system.saveAcademicYear;
        document.getElementById('form-add-user').onsubmit = APP.actions.addUser;
        document.getElementById('form-edit-perms').onsubmit = APP.actions.savePerms;
        document.getElementById('form-add-class').onsubmit = APP.actions.addClass;
        document.getElementById('form-edit-class').onsubmit = APP.actions.saveEditedClass;
        // Date Picker Change Listener
        document.getElementById('att-date-picker').addEventListener('change', (e) => {
            APP.attendance.changeDate(e.target.value);
        });
        APP.init();
    </script>
</body>
</html>
